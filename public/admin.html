<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë Admin Panel - Sheba Bingo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #1a1a2e; color: white; padding: 20px; }
        
        .login-screen, .admin-panel { max-width: 800px; margin: 0 auto; }
        .login-screen { text-align: center; padding: 50px; }
        
        .admin-panel { display: none; }
        .header { background: #162447; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #0f3460; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 2em; color: #e94560; font-weight: bold; }
        
        .section { background: #0f3460; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .deposit-item { background: #1f4068; padding: 15px; margin: 10px 0; border-radius: 10px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-approve { background: #2ecc71; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-login { background: #3498db; color: white; padding: 15px 30px; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; }
        .screenshot-img { max-width: 300px; border-radius: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <h1>üëë SHEBA BINGO ADMIN</h1>
        <p>Enter password to access admin panel</p>
        <input type="password" id="password" placeholder="Admin password">
        <button class="btn btn-login" onclick="login()">LOGIN</button>
        <p id="loginError" style="color: #e74c3c; margin-top: 10px;"></p>
    </div>
    
    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h2>üëë Sheba Bingo Admin Panel</h2>
            <button class="btn btn-logout" onclick="logout()">LOGOUT</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div>Total Users</div>
                <div class="stat-value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <div>Pending Deposits</div>
                <div class="stat-value" id="pendingDeposits">0</div>
            </div>
            <div class="stat-card">
                <div>Total Balance</div>
                <div class="stat-value" id="totalBalance">0 ETB</div>
            </div>
        </div>
        
        <!-- Pending Deposits -->
        <div class="section">
            <h3>‚è≥ Pending Deposits</h3>
            <div id="depositsList">
                <!-- Deposits will be loaded here -->
            </div>
        </div>
        
        <!-- All Users -->
        <div class="section">
            <h3>üë• All Users</h3>
            <div id="usersList">
                <!-- Users will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let adminToken = null;
        
        // Login function
        async function login() {
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adminToken = data.token;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadDashboard();
                } else {
                    errorEl.textContent = data.error || 'Wrong password!';
                }
            } catch (error) {
                errorEl.textContent = 'Connection error';
            }
        }
        
        // Load dashboard data
        async function loadDashboard() {
            await loadDeposits();
            await loadUsers();
            setInterval(loadDeposits, 5000); // Refresh every 5 seconds
        }
        
        // Load pending deposits
        async function loadDeposits() {
            try {
                const response = await fetch('/api/admin/deposits');
                const data = await response.json();
                
                // Update stats
                document.getElementById('pendingDeposits').textContent = data.deposits.length;
                
                // Display deposits
                const depositsList = document.getElementById('depositsList');
                depositsList.innerHTML = '';
                
                data.deposits.forEach(deposit => {
                    const depositEl = document.createElement('div');
                    depositEl.className = 'deposit-item';
                    depositEl.innerHTML = `
                        <div><strong>User:</strong> ${deposit.username} (${deposit.userId})</div>
                        <div><strong>Time:</strong> ${new Date(deposit.date).toLocaleString()}</div>
                        <div><strong>Screenshot:</strong> 
                            <img src="https://api.telegram.org/file/bot${BOT_TOKEN}/${deposit.filePath}" 
                                 class="screenshot-img" 
                                 onerror="this.style.display='none'">
                        </div>
                        <div>
                            <input type="number" id="amount_${deposit.id}" placeholder="Amount (ETB)" min="10">
                            <button class="btn btn-approve" onclick="approveDeposit('${deposit.id}')">APPROVE</button>
                            <button class="btn btn-reject" onclick="rejectDeposit('${deposit.id}')">REJECT</button>
                        </div>
                    `;
                    depositsList.appendChild(depositEl);
                });
            } catch (error) {
                console.error('Error loading deposits:', error);
            }
        }
        
        // Approve deposit
        async function approveDeposit(depositId) {
            const amount = document.getElementById(`amount_${depositId}`).value;
            
            if (!amount || amount < 10) {
                alert('Enter valid amount (minimum 10 ETB)');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        depositId: depositId,
                        amount: parseFloat(amount)
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Deposit approved! Balance added to user.');
                    loadDeposits();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Network error');
            }
        }
        
        // Reject deposit
        async function rejectDeposit(depositId) {
            if (!confirm('Reject this deposit?')) return;
            
            try {
                const response = await fetch('/api/admin/reject', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({depositId: depositId})
                });
                
                alert('Deposit rejected');
                loadDeposits();
            } catch (error) {
                alert('Error rejecting deposit');
            }
        }
        
        // Load all users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                // Update stats
                document.getElementById('totalUsers').textContent = data.users.length;
                
                const totalBalance = data.users.reduce((sum, user) => sum + user.balance, 0);
                document.getElementById('totalBalance').textContent = totalBalance + ' ETB';
                
                // Display users
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                data.users.forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'deposit-item';
                    userEl.innerHTML = `
                        <div><strong>ID:</strong> ${user.id}</div>
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Balance:</strong> ${user.balance} ETB</div>
                        <div><strong>Registered:</strong> ${user.registered ? '‚úÖ' : '‚ùå'}</div>
                        <button class="btn" onclick="editBalance('${user.id}', ${user.balance})">EDIT BALANCE</button>
                    `;
                    usersList.appendChild(userEl);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Edit user balance
        async function editBalance(userId, currentBalance) {
            const newBalance = prompt('Enter new balance:', currentBalance);
            
            if (newBalance && !isNaN(newBalance)) {
                try {
                    const response = await fetch('/api/admin/update-balance', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            userId: userId,
                            balance: parseFloat(newBalance)
                        })
                    });
                    
                    alert('Balance updated!');
                    loadUsers();
                } catch (error) {
                    alert('Error updating balance');
                }
            }
        }
        
        // Logout
        function logout() {
            adminToken = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }
        
        // Auto-focus password field
        document.getElementById('password').focus();
    </script>
</body>
</html>
